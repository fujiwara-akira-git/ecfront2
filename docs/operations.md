# Operations & Recent Actions

This document summarizes the recent debugging and maintenance actions performed in the repo and provides commands and next steps for common follow-ups.

## Summary of actions (2025-09-21)

- Collected Stripe webhook request logs to `tmp/stripe-webhook-logs.jsonl` and derived matches to `tmp/stripe-webhook-matches.jsonl` (42 matches).
- Added `tmp/verify-webhook-signatures.js` to verify `stripe-signature` values against `STRIPE_WEBHOOK_SECRET`.
- Augmented `app/api/payments/webhook/route.ts` to append detailed debug logs (headers including forwarded headers, raw body length and preview, handler results) into `tmp/stripe-webhook-logs.jsonl`.
- Added `scripts/delete-myproduct-products.js` to safely delete `Product` records whose name contains `myproduct` with `--dry-run` and `--confirm` flags.
- Ran `scripts/delete-myproduct-products.js --dry-run` and then executed `--confirm` to delete 7 products. Results were written to `tmp/delete-myproduct-results.jsonl`.

## Important output files

- `tmp/stripe-webhook-logs.jsonl` — raw incoming webhook logs appended by the webhook route.
- `tmp/stripe-sessions.jsonl`, `tmp/stripe-sessions-summary.jsonl` — Stripe Checkout Session fetch output.
- `tmp/stripe-webhook-matches.jsonl` — matched checkout.session.completed webhook entries (42 entries).
- `tmp/stripe-webhook-signature-verification.jsonl` — (generated by `tmp/verify-webhook-signatures.js`) verification results.
- `tmp/delete-myproduct-results.jsonl` — output of `scripts/delete-myproduct-products.js` showing deleted items.

## Quick verification commands

- Run signature verification locally (requires `STRIPE_WEBHOOK_SECRET`):

```bash
STRIPE_WEBHOOK_SECRET=whsec_xxx node tmp/verify-webhook-signatures.js
```

- Resend a specific Stripe event (useful if verification fails and you want to re-run handler):

```bash
stripe events resend <event_id>
```

- Inspect deleted products in DB (replace `DATABASE_URL` as appropriate):

```bash
psql "$DATABASE_URL" -c "SELECT id, name FROM \"Product\" WHERE name ILIKE '%myproduct%';"
```

- Start Prisma Studio for manual inspection:

```bash
npx prisma studio --schema=prisma/schema.prisma
```

## Next recommended actions

1. Run `tmp/verify-webhook-signatures.js` with `STRIPE_WEBHOOK_SECRET` to assess how many logged webhooks had valid signatures.
2. If many signatures are invalid, investigate proxies/forwarders (Stripe CLI `listen` options, ngrok, or any reverse proxy) for header/body changes. Check `x-forwarded-proto`/`host` values in `tmp/stripe-webhook-logs.jsonl`.
3. Use `stripe events resend` for failing events to confirm handler reachability and DB writes after increasing debug logs.
4. If you need to restore deleted products, prepare DB backups and a restore plan — contact me if you want me to draft restore commands.

## Contact

If you want me to run the signature verification or prepare a restore plan, reply with which action to take and any required secrets (`STRIPE_WEBHOOK_SECRET`) or confirmations (for restore).
