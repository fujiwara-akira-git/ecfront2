# 要件定義書

作成日: 2025-09-02

## 目的
- 道の駅・農産物直売所向けの EC / POS 統合プラットフォームを提供する。
- 店舗（POS）とオンライン（EC）売上、在庫、会計（freee等）を連携し運用負荷を下げる。

## スコープ（機能要件）
1. EC フロント機能
   - 商品一覧、商品詳細、カート、注文作成
   - カートの数量変更、送料計算、注文完了表示
2. 管理機能
   - 管理画面（店舗、在庫、売上確認）
3. POS 統合
   - Square 等 POS からの Webhook 受信
   - 受信イベントを保存し、夜間バッチで EC 在庫へ反映
4. 会計連携（freee）
   - 注文を freee の仕訳（voucher）として送信
   - 取引先は注文者を登録／再利用
   - 軽減税率（8%）対応（必須）、税抜ベース主運用
   - 返金時に逆仕訳を自動登録
5. 生産者向けモバイル機能（iOS）
   - 生産者が商品に対して出荷予定（数量・出荷予定日）を登録
   - 出荷完了ボタンで status を更新し在庫引落を起動

## 非機能要件
- 通貨: JPY のみ
- スケーラビリティ: 小〜中規模想定（まずは Firebase / Firestore でプロトタイプ）
- 可用性: 冗長化は将来的課題（本番は GCP/AWS 稼働想定）
- セキュリティ: Webhook 署名検証、環境変数で機密情報管理

## 運用要件
- ローカル開発: Firebase エミュレータで E2E を実行可能
- テスト: TypeScript 型チェック、エミュレータでのシード実行

## 受入基準
1. UI の主要フロー（商品一覧→カート→注文）が動作すること
2. POS Webhook を受信し、イベントが保存されること
3. freee への voucher 送信が成功する（テスト環境）こと
4. 生産者が出荷予定登録と出荷完了を iOS から行えること

## 現状ステータス（2025-09-02）
- UI 改善: 実装済
- freee 連携: スケルトン実装（voucher 送信テンプレートあり）
- Firestore シード: 実装済（emulator 対応）
- Webhook 署名検証: サンプル/テスト済
- 在庫のトランザクション安全化: 未実装（要優先対応）
