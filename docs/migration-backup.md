# マイグレーションのバックアップとリスク評価

このドキュメントは、Prisma によるスキーママイグレーションを本番データベースに適用する前の安全手順、バックアップ取得、ロールバック手順、及びリスク評価をまとめたものです。

## 対象

- データベース: PostgreSQL（例: Neon, AWS RDS, Heroku Postgres など）
- マイグレーションツール: Prisma Migrate

## 事前準備

# マイグレーションのバックアップとリスク評価

このドキュメントは、Prisma によるスキーママイグレーションを本番データベースに適用する前の安全手順、バックアップ取得、ロールバック手順、及びリスク評価をまとめたものです。

## 対象

- データベース: PostgreSQL（例: Neon, AWS RDS, Heroku Postgres など）
- マイグレーションツール: Prisma Migrate

## 事前準備

- 実行権限: スナップショット作成・復元が可能なアカウントを用意する。
- メンテナンスウィンドウ: 破壊的変更がある場合は短いメンテナンス時間を計画する。
- ステージング検証: 本番に近い状態で事前検証を行う。

## バックアップ手順（Postgres 一般）

1. ファイルベースのスナップショット（マネージド DB 推奨）

   - RDS / Neon などの管理コンソールでスナップショットを作成し、識別子を記録する。

2. 論理ダンプ（pg_dump）

   - 本番 DB にアクセスできる環境から論理バックアップを作成します:

   ```bash
   PGPASSWORD="$DB_PASSWORD" pg_dump -h $DB_HOST -U $DB_USER -p $DB_PORT -Fc -f backup_$(date +%Y%m%d_%H%M%S).dump $DB_NAME
   ```

   - `-Fc` はカスタム形式（`pg_restore` で復元）。

3. トランザクションログ / WAL の保持（必要に応じて）

   - PITR（Point-in-Time Recovery）が必要な場合はプロバイダの WAL 保存機能を利用する。

## マイグレーション適用手順（安全志向）

1. ステージングでの検証: ステージング環境でマイグレーションを適用し、主要フローを確認する。
2. フルバックアップ取得: スナップショットまたは `pg_dump` を取得する。
3. ロック・接続数の確認: 大規模 DDL の場合はロックや接続状況を監視する。
4. 必要に応じてメンテナンスモードへ移行する。
5. マイグレーション実行（非対話推奨）:

   ```bash
   DATABASE_URL="$PROD_DATABASE_URL" npx prisma migrate deploy
   ```

6. エラー発生時: ログを収集し、原因を特定してからロールバックを検討する。

## ロールバック手順

Prisma に自動ロールバックコマンドはありません。一般的な方法は次の通りです。
---
# マイグレーションのバックアップとリスク評価

このドキュメントは、Prisma によるスキーママイグレーションを本番データベースに適用する前の安全手順、バックアップ取得、ロールバック手順、およびリスク評価をまとめたものです。

## 対象

- データベース: PostgreSQL（例: Neon, AWS RDS, Heroku Postgres など）
- マイグレーションツール: Prisma Migrate

## 事前準備

- 実行権限: スナップショット作成・復元が可能なアカウントを用意する。
- メンテナンスウィンドウ: 破壊的変更がある場合は短いメンテナンス時間を計画する。
- ステージング検証: 本番に近い状態でマイグレーションを事前検証する。

## バックアップ手順（Postgres 一般）

1. ファイルベースのスナップショット（マネージド DB 推奨）

   - 管理コンソール（RDS / Neon など）でスナップショットを作成し、識別子を記録する。

2. 論理ダンプ（pg_dump）

   - 本番 DB にアクセス可能な環境から次のコマンドで論理バックアップを作成します。

   ```bash
   PGPASSWORD="$DB_PASSWORD" pg_dump -h $DB_HOST -U $DB_USER -p $DB_PORT -Fc -f backup_$(date +%Y%m%d_%H%M%S).dump $DB_NAME
   ```

   - `-Fc` はカスタム形式（復元に `pg_restore` を使用）。

3. トランザクションログ / WAL の保持（必要に応じて）

   - PITR（Point-in-Time Recovery）が必要な場合はプロバイダの WAL 保存機能を利用する。

## マイグレーション適用手順（安全志向）

1. ステージングで検証: ステージング環境でマイグレーションを適用し、主要フローを確認する。
2. フルバックアップ取得: スナップショットまたは `pg_dump` を取得する。
3. ロック・接続数の確認: 大規模 DDL の場合はロックや接続状況を監視する。
4. 必要に応じてメンテナンスモードへ移行する。
5. マイグレーション実行（非対話推奨）:

   ```bash
   DATABASE_URL="$PROD_DATABASE_URL" npx prisma migrate deploy
   ```

6. エラー発生時: ログを収集し、原因を特定してからロールバックを検討する。

## ロールバック手順

Prisma に自動ロールバック機能はありません。一般的な復旧方法は以下のとおりです。

1. スナップショットからのリストア（推奨）

   - マネージド DB のスナップショットを使用して復元する。ダウンタイムを伴うが確実。

2. 論理ダンプからの復元

   ```bash
   PGPASSWORD="$DB_PASSWORD" pg_restore -h $DB_HOST -U $DB_USER -d $DB_NAME -v backup_file.dump
   ```

3. 逆マイグレーション（限定的）

   - 事前に逆 SQL を用意している場合は手動で適用できる。ただしデータ損失や人的ミスのリスクが高い。

## リスク評価

- 破壊的変更（カラム削除や型変更など）はデータ損失のリスクを伴う。
- マイグレーション中にコードとスキーマの一時的不整合が発生することがある。
- 大規模テーブルへの DDL は長時間ロックを発生させ、サービスに影響する可能性がある。

## 注意点とベストプラクティス

- 破壊的変更は可能であれば次の 2 ステップで実施する:

  1. 新しいカラム/テーブルを追加し、アプリを両対応にする（読み書き両対応期間）。
  2. 古いカラムの読み取りを止め、データ移行後に削除する。

- マイグレーションは必ずステージングで検証する。
- 本番適用前にフルバックアップを取得する。
- 監視とアラート（ログ、エラーメトリクス）を用意する。

## 付録: よく使うコマンド

- 管理コンソールでのスナップショット作成（プロバイダ依存）。
- `pg_dump`（論理ダンプ）。
- `pg_restore`（復元）。
- `npx prisma migrate deploy`（本番向け）。
- `npx prisma migrate dev`（ローカル開発用）。

---

必要であれば、Neon や AWS RDS 向けの具体的手順（CLI / コンソール操作）を追記します。あなたが使っているプロバイダを教えてください。


- マイグレーションは必ずステージングで検証する。
- 本番実行前にフルバックアップを取得する。
- 監視（ログ、エラーメトリクス）を用意して、問題が起きたら直ちに検出できるようにする。

## 付録: よく使うコマンド

- スナップショット（例: AWS RDS はコンソール操作）
- `pg_dump`（論理ダンプ）
- `pg_restore`（復元）
- `npx prisma migrate deploy`（本番向け非対話的）
- `npx prisma migrate dev`（ローカル/開発環境向け）

---

必要であれば、このドキュメントにあなたのクラウドプロバイダ（Neon, AWS RDS, Railway など）向けの具体的なスナップショット手順と CLI コマンドを追記します。どのプロバイダを使っていますか？

```bash
PGPASSWORD="$DB_PASSWORD" pg_restore -h $DB_HOST -U $DB_USER -d $DB_NAME -v backup_file.dump
```

3. **逆マイグレーション（限定的）**
   - 予め逆マイグレーション SQL を手作業で作っておき、適用できる場合はそれを用いる。ただし人的ミスやデータの損失リスクがある。

## リスク評価
- 破壊的変更（カラム削除、型変更、外部キーの削除など）はデータ損失のリスクを伴う。
- マイグレーション中のアプリケーションの不整合: マイグレーションが複数ステップに分かれる場合、コードと DB スキーマの兼ね合いで一時的に不整合が発生することがある。互換性のある手順を設計すること。
- 大規模テーブルの DDL は長時間ロックを発生させ、サービスに影響する可能性がある。

## 注意点とベストプラクティス
- 可能であれば、破壊的変更は以下の 2 ステップで行う:
  1. 新しいカラム/テーブルを追加してアプリ側で読み書きの両対応を作る（両対応期間）。
  2. 古いカラムの読み取りを止め、データ移行後に古いカラムを削除する。

- マイグレーションは必ずステージングで検証する。
- 本番実行前にフルバックアップを取得する。
- 監視（ログ、エラーメトリクス）を用意して、問題が起きたら直ちに検出できるようにする。

## 付録: よく使うコマンド
- スナップショット（例: AWS RDS はコンソール操作）
- `pg_dump`（論理ダンプ）
- `pg_restore`（復元）
- `npx prisma migrate deploy`（本番向け非対話的）
- `npx prisma migrate dev`（ローカル/開発環境向け）

---

必要であれば、このドキュメントにあなたのクラウドプロバイダ（Neon, AWS RDS, Railway など）向けの具体的なスナップショット手順と CLI コマンドを追記します。どのプロバイダを使っていますか？
