# freee 連携：要件と設計メモ

以下はこのプロジェクト用の freee 仕訳連携の設計メモです。

目的: EC/店頭の受注・返金を freee に自動で連携して会計仕訳を作成する。

前提（ユーザー指定）
- 仕訳: 一般的な設定で可
- 軽減税率: 必須（8%）
- 税抜/税込価格運用: サービス側は税抜金額を主としつつ、税込表記にも対応できる実装とする（設定で切替）
- 取引先: 注文者（顧客）を取引先として登録する
- 退款/返金: 自動で仕訳を作成する
- 通貨: 円（JPY）のみ対応
- 複数店舗/複数拠点: 有り → 店舗ごとに "部門" や "勘定科目" を割り当て可能にする

設計ハイライト

- データモデル（簡略）
  - Order: id, amountSubtotal(税抜), taxAmount, amountTotal(税込), currency='JPY', items[], customer{name, email, freee_partner_id?}, shopId, createdAt
  - Refund: orderId, amount, reason, createdAt

- 税計算と軽減税率
  - 各注文アイテムに taxRate を持たせる（標準10% / 軽減8%）。
  - サーバ側で税抜金額を基準に仕訳金額を算出する。税込金額で受領している場合は、設定で税込→税抜に変換するヘルパーを使う。

- マッピング（仕訳）方針
  - 売上（EC/店頭）は売上科目（科目は店舗/チャネルに紐付け可能）。
  - 消費税は税区分ごとに分けて仕訳する（軽減税率と通常税率を区別）。
  - 取引先は注文者を登録：freee の取引先IDがあれば再利用、なければ作成して ID を保存。
  - 返金は売上の逆仕訳として登録し、必要に応じて現金/口座（返金手段）勘定を使う。

- マッピング例（概念）
  - 売上（税抜）: 勘定科目 = 売上高（店舗別設定）
  - 消費税（10%）: 勘定科目 = 仮受消費税等（税区分10%）
  - 消費税（軽減8%）: 勘定科目 = 仮受消費税等（税区分8%）

- 運用・同期
  - 即時送信: 注文確定時に freee に送る（非同期キューで再試行）
  - 返金: 返金確定時に自動で送る
  - 複数店舗: Order.shopId を freee の "部門" または "取引先補助項目" にマップする

- セキュリティ
  - freee API の認証情報は環境変数に保管
  - サーバ間呼び出しは署名／シークレットで保護

実装スケルトン: lib/integrations/freee.ts
- まずは最小限の voucher (仕訳) 送信を実装する。OAuth 実装や正確な API ボディは freee の API リファレンスに合わせて調整する。

次のステップ
1. この設計で問題なければ、実装を本格化して OAuth フロー（もし必要なら）と E2E テストを追加します。
2. freee のテスト環境の有無（テストアカウント）を教えてください。sandbox があると安全に動作確認できます。

参考: freee API の具体的なフィールドは現行ドキュメントに合わせて最終ボディを調整します。
